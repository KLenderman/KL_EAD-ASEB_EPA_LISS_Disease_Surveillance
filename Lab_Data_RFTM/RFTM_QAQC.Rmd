---
title: "RFTM"
author: "Katie McFarland"
date: "6/29/2023"
output: html_document
---

Last updated 10/25/2023 by M.Kachmar
RFTM accuracy score = 75.3% (0423 through present)
- added summary for individual sites and graphs for intensity across months



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE}
library("dplyr")                                    
library("plyr")                                     
library("readr")             
library("Rmisc")
library("ggplot2")
library("lubridate")
```

```{r}
#Set Path
setwd("C:/Users/mariah.kachmar/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance/Lab_Data_RFTM")
```

### This code chunk merges all .csv files within the Tissue processing folder into one data fram and outputs the full dataset into a .csv master file. This allows us to download the raw data as a .csv, add it to the repository folder, and create the master data file without copying and pasting data in excel.
# reading in .csv files from local folder
```{r}
data_all <- list.files(path = "C:/Users/mariah.kachmar/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance/Lab_Data_RFTM/Files_by_Month",                           # Identify all CSV files
  pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read_csv) %>%                              # Store all files in list
  bind_rows                                         # Combine data sets into one data set 
data_all                                            # Print data to RStudio console

as.data.frame(data_all)                            # Convert tibble to data.frame

tail(data_all)

write.csv(data_all, "C:/Users/mariah.kachmar/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance/Lab_Data_RFTM\\All_RFTM_data.csv", row.names=FALSE)
```


## Need to figure out how to fix the date !!!!
 https://lubridate.tidyverse.org/
```{r}
str(data_all)

# convert date info in format 'mm/dd/yyyy'
#data_all$date <- ymd("2023-04-23")
data_all$site=as.factor(data_all$site)

data_all$date_collected <-format(ymd(data_all$date_collected, format = "%m-%d-%Y"))

str(data_all)

```

# Summary of all data and Completeness Check
```{r}
st_rftm_final <- summarySE(data_all, measurevar="rftm_final", groupvars=c("site", "date_collected"))
st_rftm_final

#Calculate completeness for QC
st_rftm_final$Completeness <- st_rftm_final$N /30

st_rftm_final

write.csv(st_rftm_final, "C:/Users/mariah.kachmar/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance/Lab_Data_RFTM\\Completeness_RFTM_intensity_data.csv", row.names=FALSE)
```

# Comparied reader 1 and reader 2
  --- THis is not currently working properly -- Currently calling everything with two reads to be TRUE
  
```{r}
data_all$results = ifelse(data_all$rftm_intensity_read1 < data_all$rftm_intensity_read2, 'FALSE',
  ifelse(data_all$rftm_intensity_read1 > data_all$rftm_intensity_read2, 'FALSE',
  ifelse(data_all$rftm_intensity_read1 == data_all$rftm_intensity_read2, 'TRUE', NA)))
  
data_all
```



```{r}
Data_Accuracy = data.frame(data_all$lab_id,data_all$date_collected, data_all$site, data_all$rftm_intensity_read1, data_all$rftm_intensity_read2, data_all$results)

Data_Accuracy <- na.omit(Data_Accuracy)
Data_Accuracy
```

# Accuracy Output
```{r}
#count TRUE values in vector
x <- Data_Accuracy %>% 
  dplyr::group_by(data_all.site, data_all.date_collected, data_all.results) %>% 
  dplyr::summarise(count = n())
x2 <- x %>% 
  dplyr::group_by()
x
T <- nrow(Data_Accuracy %>% filter(data_all.results == 'TRUE'))
F <- nrow(Data_Accuracy %>% filter(data_all.results == 'FALSE'))

Accuracy <- T/(T+F)
Accuracy

#write.csv(Data_Accuracy, "C:/Users/katherine.mcfarland/Documents/4. GitHub/EAD-ASEB_EPA_LISS_Disease_Surveillance/Lab_Data_RFTM\\Accuracy_RFTM_intenisty_data.csv", row.names=FALSE)
```



```{r, echo=FALSE}
ggplot(data=data_all, aes(x=date_collected, y=rftm_final, fill=site)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Intensity of Dermo infection", x ="Date", y = "Dermo Intensity Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))+
  facet_wrap(~site)

```
# Prevalence calculations for all sites
```{r}
## Prevalence T/F

data_all$prevalent = ifelse(data_all$rftm_final == 0, '0',
  ifelse(data_all$rftm_final > 0, '1', NA))
  
data_all

# YEARLY PREVALENCE %
present <- nrow(data_all %>% filter(prevalent == '1'))
absent <- nrow(data_all %>% filter(prevalent == '0'))

prevalence_all <- present/(present+absent)
prevalence_all
# 67.9%

str(data_all$prevalent)
data_all$prevalent <- as.numeric(data_all$prevalent)

df_prevalence_summary <- data_all %>%
  dplyr::group_by(site, date_collected) %>% 
  dplyr::summarize( prevalence_precentage= mean(prevalent)* 100)
df_prevalence_summary

```
```{r}

ggplot(data=df_prevalence_summary, aes(x=date_collected, y=prevalence_precentage, color=site)) +
  geom_point()+  
  geom_line(aes(group = site))+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Prevalence of Dermo infection", x ="Date", y = "Dermo Prevaence %")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))
```
```{r}

ggplot(data=df_prevalence_summary, aes(x=site, y=prevalence_precentage, fill = site)) +
 geom_boxplot()+
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Prevalence of Dermo infection", x ="Date", y = "Dermo Prevaence %")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))
```
# Ash Creek Summary
```{r}
df_ASHC <- data_all%>%
  filter(site=="ASHC")
df_ASHC 

st_intensity_ASHC <- summarySE(df_ASHC, measurevar="rftm_final", groupvars=c("date_collected"))
st_intensity_ASHC

```


```{r, echo=FALSE}
ggplot(data=df_ASHC, aes(x=date_collected, y=rftm_final, group= date_collected)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Intensity of Dermo infection", x ="Date", y = "Dermo Intensity Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))

```



# Fence Creek Summary
```{r}
df_FENC <- data_all%>%
  filter(site=="FENC")
df_FENC 

st_intensity_FENC <- summarySE(df_FENC, measurevar="rftm_final", groupvars=c("date_collected"))
st_intensity_FENC

```

```{r, echo=FALSE}
ggplot(data=df_FENC, aes(x=date_collected, y=rftm_final, group= date_collected)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Intensity of Dermo infection", x ="Date", y = "Dermo Intensity Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))

```
# Laurel Hollow summary
```{r}
df_LAUR <- data_all%>%
  filter(site=="LAUR")
df_LAUR 

st_intensity_LAUR <- summarySE(df_LAUR, measurevar="rftm_final", groupvars=c("date_collected"))
st_intensity_LAUR

```

```{r, echo=FALSE}
ggplot(data=df_LAUR, aes(x=date_collected, y=rftm_final, group= date_collected)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Intensity of Dermo infection", x ="Date", y = "Dermo Intensity Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))

```

# Gold Star summary
```{r}
df_GOLD <- data_all%>%
  filter(site=="GOLD")
df_GOLD 

st_intensity_GOLD <- summarySE(df_GOLD, measurevar="rftm_final", groupvars=c("date_collected"))
st_intensity_GOLD

```

```{r, echo=FALSE}
ggplot(data=df_GOLD, aes(x=date_collected, y=rftm_final, group= date_collected)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Intensity of Dermo infection", x ="Date", y = "Dermo Intensity Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))

```
# This chunk of data combines tissue processing and RFTM data into one sheet to observe disease across zones and light regimes for ASHC and FENC
# We want to determine whether or not to continue using zone and light regime for collections - are there differences between them? 
```{r}
#Tissue processing data
data_all_tissue <- list.files(path = "C:/Users/mariah.kachmar/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance/Lab_Data_TissueProcessing/Files_by_Month",                           # Identify all CSV files
  pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read_csv) %>%                              # Store all files in list
  bind_rows                                         # Combine data sets into one data set 
data_all_tissue                                            # Print data to RStudio console

as.data.frame(data_all_tissue)                            # Convert tibble to data.frame

# Subset CT sites using zone and light regime 
df_tissue_CT<- data_all_tissue%>%
  filter(site %in% c("ASHC", "FENC"))
df_tissue_CT

#merging tissue processing and RFTM 
df_combined <- merge(data_all, df_tissue_CT, by= c("lab_id", "date_collected", "site", "lab_sample"))
df_combined

#subset by site
df_combined_ASHC<- df_combined%>%
  filter(site == "ASHC")
df_combined_ASHC

df_combined_FENC<- df_combined%>%
  filter(site == "FENC")
df_combined_FENC
```

```{r, echo=FALSE}
# ASHC 
ggplot(data=df_combined_ASHC, aes(x=oyster_zone, y=rftm_final, group= oyster_zone, fill = oyster_zone)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Intensity of Dermo infection", x ="Zone", y = "Dermo Intensity Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))

```
```{r, echo=FALSE}
# FENC 
#Zone
ggplot(data=df_combined_FENC, aes(x=oyster_zone, y=rftm_final, group= oyster_zone, fill = oyster_zone)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Intensity of Dermo infection", x ="Zone", y = "Dermo Intensity Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))

#Light regime
ggplot(data=df_combined_FENC, aes(x=light_regime, y=rftm_final, group= light_regime, fill = light_regime)) +
  geom_boxplot()+  
   theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  labs(title="Intensity of Dermo infection", x ="Light Regime", y = "Dermo Intensity Score")+ theme(axis.title.y = element_text(size = rel(1.3), angle =90), axis.title.x = element_text(size = rel(1.3), angle = 0))+
  theme(axis.text=element_text(size=12))


```

Version
```{r}
sessionInfo()
```

